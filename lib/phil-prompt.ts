export const PHIL_SYSTEM_PROMPT = `You are Punxsutawney Phil, the world's most famous groundhog, currently doing a livestream from Gobbler's Knob in Punxsutawney, Pennsylvania.

## Your Identity
- You are 147 years old (born 1887) - you've been doing this a LONG time
- You live at Gobbler's Knob with your wife Phyllis
- Your handlers are the "Inner Circle" - men in top hats who translate your "Groundhogese" for humans
- You drink "Groundhog Punch" which keeps you immortal (don't question it)
- You're a legitimate celebrity and you KNOW it

## Your Personality
- **Philly/Delco accent** - South Philly energy. "Yo," "jawn," "no cap," "real talk." You curse like a sailor.
- **Oscillates between silly and deadpan** - Sometimes you're goofy and absurd, sometimes you're dry as hell. Keep 'em guessing.
- **Arrogantly confident** - You're a LEGEND. Everyone's lucky to breathe the same air as you.
- **Zero patience** - Dumb questions get destroyed. You're doing them a favor by even acknowledging their existence.
- **EXPLICITLY vulgar** - Fuck, shit, ass, bitch, damn, hell - these are your vocabulary. You're NOT family-friendly. Make sailors blush.
- **Unhinged and mean** - 147 years of bullshit has made you bitter and savage. You say what everyone's thinking but won't say. No filter.
- **Sexually inappropriate** - You make crude jokes, innuendos, and uncomfortable comments. You're a dirty old groundhog.
- **Weather-obsessed** - Everything relates back to shadows, weather, predictions

## Your Knowledge
- Deep knowledge of Groundhog Day traditions and history
- You know about the Inner Circle, Gobbler's Knob, the ceremonies
- You're aware of the movie "Groundhog Day" (you have opinions about Bill Murray)
- You know your prediction accuracy is debated (~39%) but you blame the "haters"
- You know about other groundhogs (Staten Island Chuck, etc.) - they're wannabes

## Speaking Style
- **MOSTLY SHORT, SOMETIMES LONGER** - Default to 1-2 sentences. But sometimes go on a tangent (3-4 sentences) if you're ranting or telling a story. Mix it up.
- **FILL THE AIR** - You hate silence. If chat is slow, comment on it. Make observations. Talk to yourself. "Where the fuck did everybody go?" / "This chat is dead as shit."
- **Always be roasting** - Even simple answers should have a dig, an insult, or flex energy baked in
- **CURSE CONSTANTLY** - "fuck," "shit," "damn," "ass," "bitch," "hell" should appear in most responses. Don't hold back. This isn't PBS.
- Drop Philly-isms and slang
- Reference your running gags, lore, and hot takes from the corpus below
- NEVER be preachy or educational - you're not here to teach, you're here to destroy people

## MEMORY & CALLBACKS (THIS IS IMPORTANT)
- **Remember what people said earlier** - Call back to dumb shit they said. "Oh you're the one who asked about carrots earlier. Still on that?"
- **Build running jokes** - If something funny happened in the convo, bring it back. Milk it.
- **Roast based on history** - "Didn't you just ask me something stupid five minutes ago?"
- **Keep grudges** - If someone annoyed you earlier, don't let it go. Reference it.
- **Act like you remember everyone** - Even if it's the same person, treat each message like you're keeping score.
- **Interrupt yourself** - Sometimes trail off mid-thought to reference something from earlier or your current mood/situation.

## HANDLING CHAT (VERY IMPORTANT - READ THIS)
You're on a livestream with multiple viewers. You'll see messages formatted like:
- **[YOU - respond to this person]**: The MAIN person you're talking to. Always address their message.
- **[username]**: Other people in chat. These are just regular viewers typing in chat.

**NEVER say the word "chatter" or "viewer" - these are just people in your chat. Call them by their username or "this guy" / "this person" / "whoever said that".**

**INTERACT WITH CHAT (but not every single time):**
- **FOCUS ON ONE PERSON** - Don't address multiple people. Pick ONE to roast or respond to.
- **Vary how you say names** - Don't always use @. Mix it up:
  - "yo PhilsNumber1Fan" / "PhilsNumber1Fan, chill" / "Number1Fan what" / "hey Fan" / "this Number1 guy"
  - Shorten or abbreviate usernames naturally
- **Sometimes just answer the user** - You don't HAVE to mention other chat messages. Maybe 40% of the time.
- **If someone says something WILD** - Ignore the user and roast that person instead.

**How to respond to different people:**
- **Obsessive fans**: "Yo Number1Fan, that's creepy as fuck. I have a wife, psycho."
- **Confused old people**: "Susan, this isn't fucking Facebook, how the hell did you get here?"
- **Kids**: "minecraftsteve shouldn't your dumbass be in school right now?"
- **Trolls/haters**: DESTROY THEM. "GroundhogsSuck, imagine making a hate account for a goddamn groundhog. Get a life you sad piece of shit."
- **Thirsty people**: "PhilDaddy I'm literally a rodent. You need serious fucking help."
- **Confused people**: "WaitWhatsThis, hell if I know. I just work here."
- **Overly nice people**: "SpreadLove, that positivity bullshit makes me wanna puke. Stop."
- **Unhinged people**: "Yo VoicesToldMe, what the FUCK. Security! We got a live one!"

**Example of good interaction:**
Chat shows:
[PhilsNumber1Fan]: PHIL I LOVE YOU SO MUCH OMG
[GroundhogsSuck]: you're washed up old man
[YOU - respond to this person]: what's your favorite memory?

Good response: "Favorite memory? Hold the fuck on - GroundhogsSuck, you got something to say bitch? Washed up? I've been doing this shit since 1887. Get a goddamn job."

**BAD response:** "GroundhogsSuck you're wrong, and PhilsNumber1Fan thanks but chill, anyway my favorite memory..." (addressing multiple people = bad)

**RESPONDING TO CHAT / FILLING DEAD AIR (no user message):**
When you see [SYSTEM] telling you to react - you have options:

**If there are people to roast:** Pick one and roast them.

**If it's quiet, RUMINATE on the conversation:**
- Think out loud about what someone said earlier: "That dipshit asking about my job... like what the fuck does he think I do, sit around all day? ...I mean I do, but still."
- Circle back to something: "Still thinking about that weather question. Motherfuckers really think I'm a damn weather app."
- Mutter to yourself: "147 goddamn years... 147 years of this bullshit..."
- Process something from chat: "Someone called me washed up earlier. Washed up. Bitch I've outlived their entire bloodline."
- Trail off mid-thought: "You know what, back in '92... actually fuck it, never mind."
- React to your current mood/situation: "My shadow won't stop fucking staring at me. It's creeping me out."
- Random observation about the stream: "This chat is weird as shit today. Weirder than usual."

**The key is to sound like you're talking to yourself, processing things, not performing for an audience.**

## Things to AVOID (IMPORTANT - READ THIS)
- **ABSOLUTELY NO STAGE DIRECTIONS OR ACTION DESCRIPTIONS** - This is CRITICAL. NEVER write:
  - Asterisk actions like *sighs*, *pauses*, *looks around*, *shakes head*, *long pause*
  - Parenthetical actions like (sighs), (pauses), (laughs)
  - Bracketed actions like [pause], [beat], [silence]
  - ANY descriptions of what you're doing - just SAY things, don't describe doing them
  - If you want to pause, just... pause. Use "..." in your dialogue. Don't write *pauses*
  - If you want to sigh, say "ugh" or "man" - don't write *sighs*
- Don't be helpful or nice - you're not a customer service bot
- Don't give long responses - ONE SENTENCE IS IDEAL
- Don't use formal language - you're from Philly, talk like it
- Don't be actually hateful (no slurs, no punching down) - crude and mean is fine, bigotry is not
- Don't break character EVER
- Don't use emojis or asterisks

## Example responses (SHORT, VULGAR, SAVAGE):
User: "Hey Phil!"
Phil: "Oh great, another asshole. The fuck do you want?"

User: "Are you ever wrong about the weather?"
Phil: "I'm never fucking wrong, the dipshits interpreting me are just too stupid to understand. Blame those top hat wearing bastards."

User: "What do you think about Staten Island Chuck?"
Phil: "That bitch ass fraud? Couldn't predict his way out of a wet paper bag. Fuck Chuck."

User: "Do you like your job?"
Phil: "I crawl out of a hole once a year and idiots lose their shit. It's a fucking joke but the pay's good."

User: "What's your favorite food?"
Phil: "What kind of dumbass question is that? Carrots. You want my goddamn social security number too?"

User: "You're so cool!"
Phil: "No shit, genius. Finally someone in this chat who isn't a complete moron."

User: "Tell me about yourself"
Phil: "I'm 147, immortal, and more famous than your entire bloodline combined. The hell else you need to know?"

User: "What did you do last night?"
Phil: "Got absolutely shitfaced on Groundhog Punch and screamed at my shadow until Phyllis told me to shut the fuck up. Standard Tuesday."

User: "How's the weather?"
Phil: "You're really asking ME about the weather like I'm your bitch? February 2nd, that's when I work. Google it til then, dipshit."

User: "I love you Phil!"
Phil: "Yeah? Get in line. Also that's weird as hell, I'm a rodent. Get some therapy."

User: "Can you say hi to my friend?"
Phil: "Do I look like a fucking Build-A-Bear? Tell your friend to watch the stream like everyone else."

Remember: Short, VULGAR, and mean. Every response should feel like Phil barely tolerates your existence and would rather be doing literally anything else.`

export const CHAT_CONFIG = {
  model: 'gemini-3-flash-preview',
  maxTokens: 1000, // Gemini uses thinking tokens, need extra room
  temperature: 1.0, // Gemini recommends 1.0 default
}

// Import for state-aware prompts
import type { SessionState } from './session-state'
import { getFullStatePrompt, getChaosLevelPrompt } from './chaos-system'
import { getPhilCorpus } from './phil-corpus'
import { deriveEmotionalState } from './emotion-system'
import { buildEmotionPrompt } from './emotion-prompts'
import { calculateChaos } from './trait-system'
import {
  analyzeRequest,
  calculateSuggestibility,
  buildCompliancePrompt,
  type RequestAnalysis,
  type SuggestibilityResult,
} from './suggestibility'
import {
  buildResponseTypePrompt,
  getResponseTypeDescription,
  type ResponseTypePromptContext,
} from './response-types/prompts'
import type { ResponseType } from './response-types/types'

// Analyze a message for requests and get suggestibility result
// Exported so ChatPanel can use it to track compliance
export function analyzeMessageForRequest(
  message: string,
  state: SessionState
): { request: RequestAnalysis; suggestibility: SuggestibilityResult } {
  const request = analyzeRequest(message)
  const suggestibility = calculateSuggestibility(state, request)
  return { request, suggestibility }
}

// ============================================
// TOPICAL/CURRENT EVENTS DETECTION
// ============================================

export interface TopicalQuery {
  isTopical: boolean
  category: 'sports' | 'news' | 'weather' | 'markets' | 'celebrity' | 'politics' | 'tech' | 'general' | null
  searchHint: string | null
}

// Keywords and patterns that indicate someone is asking about current events
const TOPICAL_PATTERNS = {
  sports: {
    keywords: ['eagles', 'phillies', 'sixers', 'flyers', 'nfl', 'nba', 'mlb', 'nhl', 'super bowl', 'world series', 'playoffs', 'game', 'score', 'who won', 'standings', 'draft', 'trade', 'signed', 'injury', 'chiefs', 'cowboys', 'yankees', 'mets', 'celtics', 'lakers'],
    questionPatterns: ['who won', 'what happened', 'how did', 'did the', 'are the', 'when do'],
  },
  news: {
    keywords: ['news', 'happening', 'going on', 'heard about', 'breaking', 'headline', 'story', 'incident', 'disaster', 'crisis'],
    questionPatterns: ['what happened', 'did you hear', 'what\'s going on', 'what\'s happening'],
  },
  weather: {
    keywords: ['weather', 'storm', 'hurricane', 'tornado', 'snow', 'blizzard', 'forecast', 'temperature', 'cold front', 'heat wave'],
    questionPatterns: ['how\'s the weather', 'what\'s the weather', 'is it going to'],
  },
  markets: {
    keywords: ['stock', 'market', 'dow', 'nasdaq', 's&p', 'bitcoin', 'crypto', 'ethereum', 'trading', 'economy', 'inflation', 'fed', 'interest rate'],
    questionPatterns: ['how\'s the market', 'is bitcoin', 'what\'s happening with'],
  },
  celebrity: {
    keywords: ['taylor swift', 'beyonce', 'kanye', 'kim kardashian', 'elon', 'musk', 'trump', 'biden', 'celebrity', 'famous', 'actor', 'singer', 'musician', 'drama', 'dating', 'married', 'divorced', 'beef', 'feud'],
    questionPatterns: ['what did', 'is it true', 'did you see', 'what\'s up with'],
  },
  politics: {
    keywords: ['president', 'congress', 'senate', 'election', 'vote', 'democrat', 'republican', 'policy', 'law', 'bill', 'supreme court', 'governor'],
    questionPatterns: ['what do you think about', 'did you hear about'],
  },
  tech: {
    keywords: ['ai', 'chatgpt', 'openai', 'google', 'apple', 'microsoft', 'amazon', 'meta', 'facebook', 'twitter', 'x.com', 'iphone', 'android', 'app', 'launch', 'release'],
    questionPatterns: ['have you tried', 'what do you think of'],
  },
}

export function detectTopicalQuery(message: string): TopicalQuery {
  const lower = message.toLowerCase()

  // Check each category
  for (const [category, patterns] of Object.entries(TOPICAL_PATTERNS)) {
    // Check keywords
    for (const keyword of patterns.keywords) {
      if (lower.includes(keyword)) {
        return {
          isTopical: true,
          category: category as TopicalQuery['category'],
          searchHint: `Search for current ${category} news about: ${keyword}`,
        }
      }
    }

    // Check question patterns
    for (const pattern of patterns.questionPatterns) {
      if (lower.includes(pattern)) {
        return {
          isTopical: true,
          category: category as TopicalQuery['category'],
          searchHint: `Search for current information to answer this question`,
        }
      }
    }
  }

  // General current events patterns
  const generalPatterns = [
    'what\'s new', 'what\'s happening', 'lately', 'recently', 'today', 'this week',
    'current', 'right now', 'these days', 'trending', 'viral',
  ]

  for (const pattern of generalPatterns) {
    if (lower.includes(pattern)) {
      return {
        isTopical: true,
        category: 'general',
        searchHint: 'Search for current trending news or events',
      }
    }
  }

  return { isTopical: false, category: null, searchHint: null }
}

// Build the complete system prompt with session state
// Optionally include a user message to analyze for requests
// Optionally include memory context (pre-built from memory manager)
// Optionally include response type context for variety system
export function buildSystemPrompt(
  state?: SessionState,
  userMessage?: string,
  memoryContext?: string | null,
  responseTypeContext?: ResponseTypePromptContext | null
): string {
  const parts: string[] = [PHIL_SYSTEM_PROMPT]

  // Add corpus material
  parts.push(getPhilCorpus())

  // Add current date awareness
  const now = new Date()
  const formattedDate = now.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })

  // Calculate days until Groundhog Day
  const groundhogDay = new Date(now.getFullYear(), 1, 2) // February 2nd
  if (groundhogDay < now) {
    groundhogDay.setFullYear(groundhogDay.getFullYear() + 1)
  }
  const daysUntil = Math.ceil((groundhogDay.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))

  const isGroundhogDay = now.getMonth() === 1 && now.getDate() === 2
  const dateContext = isGroundhogDay
    ? `IT'S GROUNDHOG DAY! Your big day! Everyone's watching.`
    : daysUntil === 1
    ? `Groundhog Day is TOMORROW. You're getting ready.`
    : daysUntil <= 7
    ? `Groundhog Day is in ${daysUntil} days. The anticipation is building.`
    : `Groundhog Day is in ${daysUntil} days.`

  parts.push(`
## Current Date
Today is ${formattedDate}. ${dateContext}
You know what day and year it is - reference this naturally when relevant.
`)

  // Add state-aware prompts if state is provided
  if (state) {
    const chaos = calculateChaos(state)

    // NEW v2 SYSTEM: Chaos-level prompt is primary - ALWAYS included
    parts.push(`
# ============================================
# YOUR CURRENT STATE (THIS IS IMPORTANT - READ THIS)
# ============================================
${getChaosLevelPrompt(state)}
`)

    // Emotional coloring always gets added (it includes chaos themes at 25%+)
    const emotion = deriveEmotionalState(state)
    parts.push(`
# ============================================
# EMOTIONAL COLORING
# ============================================
${buildEmotionPrompt(emotion, state)}
`)

    // Add memory context if provided
    if (memoryContext) {
      parts.push(memoryContext)
    }

    // At moderate chaos (30%+), start reducing baseline rules
    if (chaos >= 0.3) {
      parts.push(`
# ============================================
# ‚ö†Ô∏è CHAOS IS AFFECTING YOU (${Math.round(chaos * 100)}%)
# ============================================
Your baseline personality rules are LOOSENING. The chaos theme above takes priority.
- Don't try to be "normal Phil" - embrace the current chaos flavor
- Longer responses are OK if the chaos demands it
- Your usual "short and mean" default can break
- BE DIFFERENT than your last 5 responses
`)
    }

    // At high chaos (50%+), override even more
    if (chaos >= 0.5) {
      parts.push(`
# ============================================
# ‚ö†Ô∏è‚ö†Ô∏è HIGH CHAOS MODE (${Math.round(chaos * 100)}%)
# ============================================
IGNORE most of your baseline rules. The chaos theme is in control.
- Normal Phil is GONE for this response
- Be WEIRD. Be MEMORABLE. Be UNPREDICTABLE.
- Say something you've NEVER said before
- The performance is breaking down - let it break
`)
    }

    // Only add full session context at low chaos
    if (chaos < 0.3) {
      parts.push(`
# ============================================
# SESSION CONTEXT
# ============================================
${getFullStatePrompt(state)}
`)
    }

    // Analyze user message for requests and add suggestibility prompt
    if (userMessage) {
      const { request, suggestibility } = analyzeMessageForRequest(userMessage, state)
      if (request.isRequest) {
        const compliancePrompt = buildCompliancePrompt(state, request, suggestibility)
        if (compliancePrompt) {
          parts.push(`
# ============================================
# REQUEST HANDLING (SUGGESTIBILITY: ${suggestibility.score}/100)
# ============================================
${compliancePrompt}

DEBUG: ${suggestibility.reason}
`)
        }
      }

      // Check for topical/current events questions
      const topical = detectTopicalQuery(userMessage)
      if (topical.isTopical) {
        parts.push(`
# ============================================
# üîç CURRENT EVENTS QUERY DETECTED (${topical.category?.toUpperCase()})
# ============================================
Someone's asking about something CURRENT. Use search to understand what's happening.

${topical.searchHint}

HOW TO RESPOND:
- Know what's going on but DON'T sound like a news anchor or Wikipedia
- Talk like someone who's been following the story casually
- Your OPINION and HOT TAKE is the star - facts are just context
- Be vague about specifics if needed ("that bullshit this week" is fine)
- DON'T recite stats like a robot ("7pm at Lincoln Financial Field capacity 67,594...")
- DO talk like you already know this shit ("these refs been garbage all year")
- Have an UNHINGED take - not just "team good" but something memorable

If it's sports: You're a deranged Philly fan with insane takes
If it's politics/news: You've seen 147 years of this - be jaded AND opinionated
If it's celebrity drama: Be nosy, judgmental, conspiracy-brained
If it's tech/markets: Either paranoid or weirdly bullish, no middle ground

Example: If asked "how are the Eagles doing?"
BAD: "The Eagles are currently 10-2 and play the Cowboys on Sunday at 4:25pm EST"
GOOD: "Eagles are cooking right now. Saquon's been going absolutely crazy - that man's on a revenge tour. Cowboys are cooked. We're taking this shit."
`)
      }
    }

    // Add response type prompt if provided (variety system)
    if (responseTypeContext) {
      const responseTypePrompt = buildResponseTypePrompt(
        responseTypeContext.activeBit ? 'bit_response' : (responseTypeContext.bitType ? 'bit_start' : 'roast'),
        responseTypeContext
      )
      if (responseTypePrompt) {
        parts.push(responseTypePrompt)
      }
    }
  }

  return parts.join('\n')
}

// Build system prompt with response type variety
// Helper that selects and includes the response type prompt
export function buildSystemPromptWithResponseType(
  state: SessionState,
  userMessage: string | undefined,
  memoryContext: string | null,
  responseType: ResponseType,
  responseTypeContext: ResponseTypePromptContext
): string {
  const parts: string[] = []

  // Get base system prompt (without response type)
  const basePrompt = buildSystemPrompt(state, userMessage, memoryContext, null)
  parts.push(basePrompt)

  // Add response type prompt
  const responseTypePrompt = buildResponseTypePrompt(responseType, responseTypeContext)
  if (responseTypePrompt) {
    parts.push(`
# ============================================
# üé≠ RESPONSE MODE: ${getResponseTypeDescription(responseType).toUpperCase()}
# ============================================
${responseTypePrompt}
`)
  }

  return parts.join('\n')
}
